revoke delete on table "public"."agent_shadow_logs" from "anon";

revoke insert on table "public"."agent_shadow_logs" from "anon";

revoke references on table "public"."agent_shadow_logs" from "anon";

revoke select on table "public"."agent_shadow_logs" from "anon";

revoke trigger on table "public"."agent_shadow_logs" from "anon";

revoke truncate on table "public"."agent_shadow_logs" from "anon";

revoke update on table "public"."agent_shadow_logs" from "anon";

revoke delete on table "public"."agent_shadow_logs" from "authenticated";

revoke insert on table "public"."agent_shadow_logs" from "authenticated";

revoke references on table "public"."agent_shadow_logs" from "authenticated";

revoke select on table "public"."agent_shadow_logs" from "authenticated";

revoke trigger on table "public"."agent_shadow_logs" from "authenticated";

revoke truncate on table "public"."agent_shadow_logs" from "authenticated";

revoke update on table "public"."agent_shadow_logs" from "authenticated";

revoke delete on table "public"."agent_shadow_logs" from "service_role";

revoke insert on table "public"."agent_shadow_logs" from "service_role";

revoke references on table "public"."agent_shadow_logs" from "service_role";

revoke select on table "public"."agent_shadow_logs" from "service_role";

revoke trigger on table "public"."agent_shadow_logs" from "service_role";

revoke truncate on table "public"."agent_shadow_logs" from "service_role";

revoke update on table "public"."agent_shadow_logs" from "service_role";

revoke delete on table "public"."ai_threads" from "anon";

revoke insert on table "public"."ai_threads" from "anon";

revoke references on table "public"."ai_threads" from "anon";

revoke select on table "public"."ai_threads" from "anon";

revoke trigger on table "public"."ai_threads" from "anon";

revoke truncate on table "public"."ai_threads" from "anon";

revoke update on table "public"."ai_threads" from "anon";

revoke delete on table "public"."ai_threads" from "authenticated";

revoke insert on table "public"."ai_threads" from "authenticated";

revoke references on table "public"."ai_threads" from "authenticated";

revoke select on table "public"."ai_threads" from "authenticated";

revoke trigger on table "public"."ai_threads" from "authenticated";

revoke truncate on table "public"."ai_threads" from "authenticated";

revoke update on table "public"."ai_threads" from "authenticated";

revoke delete on table "public"."ai_threads" from "service_role";

revoke insert on table "public"."ai_threads" from "service_role";

revoke references on table "public"."ai_threads" from "service_role";

revoke select on table "public"."ai_threads" from "service_role";

revoke trigger on table "public"."ai_threads" from "service_role";

revoke truncate on table "public"."ai_threads" from "service_role";

revoke update on table "public"."ai_threads" from "service_role";

revoke delete on table "public"."amendment_requests" from "anon";

revoke insert on table "public"."amendment_requests" from "anon";

revoke references on table "public"."amendment_requests" from "anon";

revoke select on table "public"."amendment_requests" from "anon";

revoke trigger on table "public"."amendment_requests" from "anon";

revoke truncate on table "public"."amendment_requests" from "anon";

revoke update on table "public"."amendment_requests" from "anon";

revoke delete on table "public"."amendment_requests" from "authenticated";

revoke insert on table "public"."amendment_requests" from "authenticated";

revoke references on table "public"."amendment_requests" from "authenticated";

revoke select on table "public"."amendment_requests" from "authenticated";

revoke trigger on table "public"."amendment_requests" from "authenticated";

revoke truncate on table "public"."amendment_requests" from "authenticated";

revoke update on table "public"."amendment_requests" from "authenticated";

revoke delete on table "public"."amendment_requests" from "service_role";

revoke insert on table "public"."amendment_requests" from "service_role";

revoke references on table "public"."amendment_requests" from "service_role";

revoke select on table "public"."amendment_requests" from "service_role";

revoke trigger on table "public"."amendment_requests" from "service_role";

revoke truncate on table "public"."amendment_requests" from "service_role";

revoke update on table "public"."amendment_requests" from "service_role";

revoke delete on table "public"."beta_signups" from "anon";

revoke insert on table "public"."beta_signups" from "anon";

revoke references on table "public"."beta_signups" from "anon";

revoke select on table "public"."beta_signups" from "anon";

revoke trigger on table "public"."beta_signups" from "anon";

revoke truncate on table "public"."beta_signups" from "anon";

revoke update on table "public"."beta_signups" from "anon";

revoke delete on table "public"."beta_signups" from "authenticated";

revoke insert on table "public"."beta_signups" from "authenticated";

revoke references on table "public"."beta_signups" from "authenticated";

revoke select on table "public"."beta_signups" from "authenticated";

revoke trigger on table "public"."beta_signups" from "authenticated";

revoke truncate on table "public"."beta_signups" from "authenticated";

revoke update on table "public"."beta_signups" from "authenticated";

revoke delete on table "public"."beta_signups" from "service_role";

revoke insert on table "public"."beta_signups" from "service_role";

revoke references on table "public"."beta_signups" from "service_role";

revoke select on table "public"."beta_signups" from "service_role";

revoke trigger on table "public"."beta_signups" from "service_role";

revoke truncate on table "public"."beta_signups" from "service_role";

revoke update on table "public"."beta_signups" from "service_role";

revoke delete on table "public"."chat_messages" from "anon";

revoke insert on table "public"."chat_messages" from "anon";

revoke references on table "public"."chat_messages" from "anon";

revoke select on table "public"."chat_messages" from "anon";

revoke trigger on table "public"."chat_messages" from "anon";

revoke truncate on table "public"."chat_messages" from "anon";

revoke update on table "public"."chat_messages" from "anon";

revoke delete on table "public"."chat_messages" from "authenticated";

revoke insert on table "public"."chat_messages" from "authenticated";

revoke references on table "public"."chat_messages" from "authenticated";

revoke select on table "public"."chat_messages" from "authenticated";

revoke trigger on table "public"."chat_messages" from "authenticated";

revoke truncate on table "public"."chat_messages" from "authenticated";

revoke update on table "public"."chat_messages" from "authenticated";

revoke delete on table "public"."chat_messages" from "service_role";

revoke insert on table "public"."chat_messages" from "service_role";

revoke references on table "public"."chat_messages" from "service_role";

revoke select on table "public"."chat_messages" from "service_role";

revoke trigger on table "public"."chat_messages" from "service_role";

revoke truncate on table "public"."chat_messages" from "service_role";

revoke update on table "public"."chat_messages" from "service_role";

revoke delete on table "public"."content_modifications" from "anon";

revoke insert on table "public"."content_modifications" from "anon";

revoke references on table "public"."content_modifications" from "anon";

revoke select on table "public"."content_modifications" from "anon";

revoke trigger on table "public"."content_modifications" from "anon";

revoke truncate on table "public"."content_modifications" from "anon";

revoke update on table "public"."content_modifications" from "anon";

revoke delete on table "public"."content_modifications" from "authenticated";

revoke insert on table "public"."content_modifications" from "authenticated";

revoke references on table "public"."content_modifications" from "authenticated";

revoke select on table "public"."content_modifications" from "authenticated";

revoke trigger on table "public"."content_modifications" from "authenticated";

revoke truncate on table "public"."content_modifications" from "authenticated";

revoke update on table "public"."content_modifications" from "authenticated";

revoke delete on table "public"."content_modifications" from "service_role";

revoke insert on table "public"."content_modifications" from "service_role";

revoke references on table "public"."content_modifications" from "service_role";

revoke select on table "public"."content_modifications" from "service_role";

revoke trigger on table "public"."content_modifications" from "service_role";

revoke truncate on table "public"."content_modifications" from "service_role";

revoke update on table "public"."content_modifications" from "service_role";

revoke delete on table "public"."design_assignments" from "anon";

revoke insert on table "public"."design_assignments" from "anon";

revoke references on table "public"."design_assignments" from "anon";

revoke select on table "public"."design_assignments" from "anon";

revoke trigger on table "public"."design_assignments" from "anon";

revoke truncate on table "public"."design_assignments" from "anon";

revoke update on table "public"."design_assignments" from "anon";

revoke delete on table "public"."design_assignments" from "authenticated";

revoke insert on table "public"."design_assignments" from "authenticated";

revoke references on table "public"."design_assignments" from "authenticated";

revoke select on table "public"."design_assignments" from "authenticated";

revoke trigger on table "public"."design_assignments" from "authenticated";

revoke truncate on table "public"."design_assignments" from "authenticated";

revoke update on table "public"."design_assignments" from "authenticated";

revoke delete on table "public"."design_assignments" from "service_role";

revoke insert on table "public"."design_assignments" from "service_role";

revoke references on table "public"."design_assignments" from "service_role";

revoke select on table "public"."design_assignments" from "service_role";

revoke trigger on table "public"."design_assignments" from "service_role";

revoke truncate on table "public"."design_assignments" from "service_role";

revoke update on table "public"."design_assignments" from "service_role";

revoke delete on table "public"."design_customizations" from "anon";

revoke insert on table "public"."design_customizations" from "anon";

revoke references on table "public"."design_customizations" from "anon";

revoke select on table "public"."design_customizations" from "anon";

revoke trigger on table "public"."design_customizations" from "anon";

revoke truncate on table "public"."design_customizations" from "anon";

revoke update on table "public"."design_customizations" from "anon";

revoke delete on table "public"."design_customizations" from "authenticated";

revoke insert on table "public"."design_customizations" from "authenticated";

revoke references on table "public"."design_customizations" from "authenticated";

revoke select on table "public"."design_customizations" from "authenticated";

revoke trigger on table "public"."design_customizations" from "authenticated";

revoke truncate on table "public"."design_customizations" from "authenticated";

revoke update on table "public"."design_customizations" from "authenticated";

revoke delete on table "public"."design_customizations" from "service_role";

revoke insert on table "public"."design_customizations" from "service_role";

revoke references on table "public"."design_customizations" from "service_role";

revoke select on table "public"."design_customizations" from "service_role";

revoke trigger on table "public"."design_customizations" from "service_role";

revoke truncate on table "public"."design_customizations" from "service_role";

revoke update on table "public"."design_customizations" from "service_role";

revoke delete on table "public"."newsletter_subscribers" from "anon";

revoke insert on table "public"."newsletter_subscribers" from "anon";

revoke references on table "public"."newsletter_subscribers" from "anon";

revoke select on table "public"."newsletter_subscribers" from "anon";

revoke trigger on table "public"."newsletter_subscribers" from "anon";

revoke truncate on table "public"."newsletter_subscribers" from "anon";

revoke update on table "public"."newsletter_subscribers" from "anon";

revoke delete on table "public"."newsletter_subscribers" from "authenticated";

revoke insert on table "public"."newsletter_subscribers" from "authenticated";

revoke references on table "public"."newsletter_subscribers" from "authenticated";

revoke select on table "public"."newsletter_subscribers" from "authenticated";

revoke trigger on table "public"."newsletter_subscribers" from "authenticated";

revoke truncate on table "public"."newsletter_subscribers" from "authenticated";

revoke update on table "public"."newsletter_subscribers" from "authenticated";

revoke delete on table "public"."newsletter_subscribers" from "service_role";

revoke insert on table "public"."newsletter_subscribers" from "service_role";

revoke references on table "public"."newsletter_subscribers" from "service_role";

revoke select on table "public"."newsletter_subscribers" from "service_role";

revoke trigger on table "public"."newsletter_subscribers" from "service_role";

revoke truncate on table "public"."newsletter_subscribers" from "service_role";

revoke update on table "public"."newsletter_subscribers" from "service_role";

revoke delete on table "public"."resume_design_assignments" from "anon";

revoke insert on table "public"."resume_design_assignments" from "anon";

revoke references on table "public"."resume_design_assignments" from "anon";

revoke select on table "public"."resume_design_assignments" from "anon";

revoke trigger on table "public"."resume_design_assignments" from "anon";

revoke truncate on table "public"."resume_design_assignments" from "anon";

revoke update on table "public"."resume_design_assignments" from "anon";

revoke delete on table "public"."resume_design_assignments" from "authenticated";

revoke insert on table "public"."resume_design_assignments" from "authenticated";

revoke references on table "public"."resume_design_assignments" from "authenticated";

revoke select on table "public"."resume_design_assignments" from "authenticated";

revoke trigger on table "public"."resume_design_assignments" from "authenticated";

revoke truncate on table "public"."resume_design_assignments" from "authenticated";

revoke update on table "public"."resume_design_assignments" from "authenticated";

revoke delete on table "public"."resume_design_assignments" from "service_role";

revoke insert on table "public"."resume_design_assignments" from "service_role";

revoke references on table "public"."resume_design_assignments" from "service_role";

revoke select on table "public"."resume_design_assignments" from "service_role";

revoke trigger on table "public"."resume_design_assignments" from "service_role";

revoke truncate on table "public"."resume_design_assignments" from "service_role";

revoke update on table "public"."resume_design_assignments" from "service_role";

revoke delete on table "public"."resume_versions" from "anon";

revoke insert on table "public"."resume_versions" from "anon";

revoke references on table "public"."resume_versions" from "anon";

revoke select on table "public"."resume_versions" from "anon";

revoke trigger on table "public"."resume_versions" from "anon";

revoke truncate on table "public"."resume_versions" from "anon";

revoke update on table "public"."resume_versions" from "anon";

revoke delete on table "public"."resume_versions" from "authenticated";

revoke insert on table "public"."resume_versions" from "authenticated";

revoke references on table "public"."resume_versions" from "authenticated";

revoke select on table "public"."resume_versions" from "authenticated";

revoke trigger on table "public"."resume_versions" from "authenticated";

revoke truncate on table "public"."resume_versions" from "authenticated";

revoke update on table "public"."resume_versions" from "authenticated";

revoke delete on table "public"."resume_versions" from "service_role";

revoke insert on table "public"."resume_versions" from "service_role";

revoke references on table "public"."resume_versions" from "service_role";

revoke select on table "public"."resume_versions" from "service_role";

revoke trigger on table "public"."resume_versions" from "service_role";

revoke truncate on table "public"."resume_versions" from "service_role";

revoke update on table "public"."resume_versions" from "service_role";

revoke delete on table "public"."style_customization_history" from "anon";

revoke insert on table "public"."style_customization_history" from "anon";

revoke references on table "public"."style_customization_history" from "anon";

revoke select on table "public"."style_customization_history" from "anon";

revoke trigger on table "public"."style_customization_history" from "anon";

revoke truncate on table "public"."style_customization_history" from "anon";

revoke update on table "public"."style_customization_history" from "anon";

revoke delete on table "public"."style_customization_history" from "authenticated";

revoke insert on table "public"."style_customization_history" from "authenticated";

revoke references on table "public"."style_customization_history" from "authenticated";

revoke select on table "public"."style_customization_history" from "authenticated";

revoke trigger on table "public"."style_customization_history" from "authenticated";

revoke truncate on table "public"."style_customization_history" from "authenticated";

revoke update on table "public"."style_customization_history" from "authenticated";

revoke delete on table "public"."style_customization_history" from "service_role";

revoke insert on table "public"."style_customization_history" from "service_role";

revoke references on table "public"."style_customization_history" from "service_role";

revoke select on table "public"."style_customization_history" from "service_role";

revoke trigger on table "public"."style_customization_history" from "service_role";

revoke truncate on table "public"."style_customization_history" from "service_role";

revoke update on table "public"."style_customization_history" from "service_role";

alter table "public"."ai_threads" drop constraint "ai_threads_status_check";

alter table "public"."content_modifications" drop constraint "content_modifications_applied_by_check";

alter table "public"."content_modifications" drop constraint "content_modifications_operation_check";

alter table "public"."design_templates" drop constraint "design_templates_category_check";

alter table "public"."style_customization_history" drop constraint "style_customization_history_customization_type_check";

drop view if exists "public"."optimizations_with_ats_v2";

alter table "public"."amendment_requests" alter column "id" set default extensions.uuid_generate_v4();

drop policy if exists "Anyone can insert beta signup" on "public"."beta_signups";

alter table "public"."beta_signups" alter column "email" set data type extensions.citext using "email"::extensions.citext;

create policy "Anyone can insert beta signup"
  on "public"."beta_signups"
  as permissive
  for insert
  to anon, authenticated
with check (((accepted_terms = true) AND (accepted_privacy = true) AND (email IS NOT NULL)));

alter table "public"."chat_messages" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."chat_sessions" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."design_customizations" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."design_templates" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."events" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."job_descriptions" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."optimizations" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."profiles" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."resume_design_assignments" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."resume_versions" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."resumes" alter column "id" set default extensions.uuid_generate_v4();

alter table "public"."ai_threads" add constraint "ai_threads_status_check" CHECK (((status)::text = ANY ((ARRAY['active'::character varying, 'archived'::character varying, 'error'::character varying])::text[]))) not valid;

alter table "public"."ai_threads" validate constraint "ai_threads_status_check";

alter table "public"."content_modifications" add constraint "content_modifications_applied_by_check" CHECK (((applied_by)::text = ANY ((ARRAY['ai_assistant'::character varying, 'user'::character varying, 'system'::character varying])::text[]))) not valid;

alter table "public"."content_modifications" validate constraint "content_modifications_applied_by_check";

alter table "public"."content_modifications" add constraint "content_modifications_operation_check" CHECK (((operation)::text = ANY ((ARRAY['replace'::character varying, 'prefix'::character varying, 'suffix'::character varying, 'append'::character varying, 'insert'::character varying, 'remove'::character varying])::text[]))) not valid;

alter table "public"."content_modifications" validate constraint "content_modifications_operation_check";

alter table "public"."design_templates" add constraint "design_templates_category_check" CHECK (((category)::text = ANY ((ARRAY['modern'::character varying, 'traditional'::character varying, 'creative'::character varying, 'corporate'::character varying])::text[]))) not valid;

alter table "public"."design_templates" validate constraint "design_templates_category_check";

alter table "public"."style_customization_history" add constraint "style_customization_history_customization_type_check" CHECK (((customization_type)::text = ANY ((ARRAY['color'::character varying, 'font'::character varying, 'spacing'::character varying, 'layout'::character varying, 'mixed'::character varying])::text[]))) not valid;

alter table "public"."style_customization_history" validate constraint "style_customization_history_customization_type_check";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.applications_update_search()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  NEW.search := to_tsvector('simple', coalesce(NEW.job_title,'') || ' ' || coalesce(NEW.company_name,''));
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.assign_default_template()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE
  default_template_id UUID;
BEGIN
  -- Get the default template (highest ATS score)
  SELECT id INTO default_template_id
  FROM design_templates
  ORDER BY ats_compatibility_score DESC, created_at ASC
  LIMIT 1;

  -- Only insert if we found a template
  IF default_template_id IS NOT NULL THEN
    INSERT INTO resume_design_assignments (
      user_id,
      optimization_id,
      template_id,
      original_template_id,
      is_active
    )
    VALUES (
      NEW.user_id,
      NEW.id,
      default_template_id,
      default_template_id,
      true
    )
    ON CONFLICT (optimization_id) DO NOTHING;
  END IF;

  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_subscription_limit(user_uuid uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
    -- Check subscription limit (currently disabled - returns TRUE)
    -- Future: Implement actual check against profiles.plan_type
    RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.cleanup_old_files(bucket_name text, days_old integer DEFAULT 30)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE 
    deleted_count INTEGER := 0; 
BEGIN 
    -- Function body preserved as-is
    RETURN deleted_count; 
END; 
$function$
;

CREATE OR REPLACE FUNCTION public.generate_file_path(user_uuid uuid, filename text, file_type text DEFAULT 'upload'::text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE 
  clean_filename TEXT; 
  timestamp_suffix TEXT; 
  file_extension TEXT; 
BEGIN
  file_extension := lower(split_part(filename, '.', -1));
  clean_filename := regexp_replace(split_part(filename, '.', 1), '[^a-zA-Z0-9_-]', '_', 'g');
  timestamp_suffix := extract(epoch from now())::text;
  RETURN user_uuid::text || '/' || file_type || '_' || clean_filename || '_' || timestamp_suffix || '.' || file_extension;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_ats_improvement(optimization_id uuid)
 RETURNS real
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE
  v_original REAL;
  v_optimized REAL;
BEGIN
  SELECT ats_score_original, ats_score_optimized
  INTO v_original, v_optimized
  FROM optimizations
  WHERE id = optimization_id;

  IF v_original IS NULL OR v_optimized IS NULL THEN
    RETURN NULL;
  END IF;

  RETURN v_optimized - v_original;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
    INSERT INTO public.profiles (user_id, full_name)
    VALUES (NEW.id, NEW.raw_user_meta_data->>'full_name');
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.increment_optimization_usage(user_uuid uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
    -- Increment optimization usage (currently disabled - returns TRUE)
    -- Future: Implement actual increment
    RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.increment_optimizations_used(user_id_param uuid, max_allowed integer)
 RETURNS profiles
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  updated_profile profiles;
BEGIN
  -- Atomic update: only increment if under quota
  -- This prevents race conditions where multiple requests could bypass the limit
  UPDATE profiles
  SET
    optimizations_used = optimizations_used + 1,
    updated_at = NOW()
  WHERE
    user_id = user_id_param
    AND plan_type = 'free'
    AND optimizations_used < max_allowed
  RETURNING * INTO updated_profile;

  -- Return the updated profile (NULL if no row was updated)
  RETURN updated_profile;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.increment_rate_limit(p_identifier text, p_endpoint text, p_window_ms bigint)
 RETURNS TABLE(requests_count integer, window_start timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
declare
  v_now timestamptz := now();
  v_requests_count integer;
  v_window_start timestamptz;
begin
  insert into public.rate_limits (identifier, endpoint, requests_count, window_start)
  values (p_identifier, p_endpoint, 1, v_now)
  on conflict (identifier, endpoint) do update
    set
      window_start = case
        when public.rate_limits.window_start < v_now - (p_window_ms * interval '1 millisecond')
          then v_now
        else public.rate_limits.window_start
      end,
      requests_count = case
        when public.rate_limits.window_start < v_now - (p_window_ms * interval '1 millisecond')
          then 1
        else public.rate_limits.requests_count + 1
      end
  returning public.rate_limits.requests_count, public.rate_limits.window_start
  into v_requests_count, v_window_start;

  return query select v_requests_count, v_window_start;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.is_ats_v2(optimization_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
DECLARE
  v_version INTEGER;
BEGIN
  SELECT ats_version INTO v_version
  FROM optimizations
  WHERE id = optimization_id;

  RETURN COALESCE(v_version, 1) >= 2;
END;
$function$
;

create or replace view "public"."optimizations_with_ats_v2" as  SELECT id,
    user_id,
    resume_id,
    jd_id,
    created_at,
    status,
    template_key,
    match_score AS legacy_score,
    ats_version,
    ats_score_original,
    ats_score_optimized,
        CASE
            WHEN ((ats_score_original IS NOT NULL) AND (ats_score_optimized IS NOT NULL)) THEN (ats_score_optimized - ats_score_original)
            ELSE NULL::real
        END AS ats_score_improvement,
    (ats_subscores -> 'keyword_exact'::text) AS subscore_keyword_exact,
    (ats_subscores -> 'keyword_phrase'::text) AS subscore_keyword_phrase,
    (ats_subscores -> 'semantic_relevance'::text) AS subscore_semantic_relevance,
    (ats_subscores -> 'title_alignment'::text) AS subscore_title_alignment,
    (ats_subscores -> 'metrics_presence'::text) AS subscore_metrics_presence,
    (ats_subscores -> 'section_completeness'::text) AS subscore_section_completeness,
    (ats_subscores -> 'format_parseability'::text) AS subscore_format_parseability,
    (ats_subscores -> 'recency_fit'::text) AS subscore_recency_fit,
    ats_subscores,
    ats_suggestions,
    ats_confidence
   FROM optimizations o;


CREATE OR REPLACE FUNCTION public.update_applications_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_session_activity()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'pg_temp'
AS $function$
BEGIN
  UPDATE chat_sessions
  SET last_activity_at = NOW(), updated_at = NOW()
  WHERE id = NEW.session_id;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

