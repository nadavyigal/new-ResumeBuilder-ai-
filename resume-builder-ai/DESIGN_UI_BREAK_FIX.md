# Design UI Breaking Bug - Root Cause Analysis & Fix

## Problem Summary
When users changed resume designs in the optimization view, the **ENTIRE PAGE UI would break** (not just the resume preview). The page would become invisible or completely unstyled.

## Root Cause

### The Bug
The template sync script (`scripts/sync-external-templates.ts`) was generating **incorrect CSS selectors with doubled class names**:

```css
/* BROKEN - Generated by sync script */
.resume-card-ssr .resume-card-ssr {
  font-family: system-ui;
  max-width: 900px;
  /* ... */
}
```

This selector requires **TWO nested elements** both with class `resume-card-ssr`, but the component only renders **ONE element** with that class:

```jsx
<div className="resume-card-ssr">  {/* Only ONE element */}
  {/* Content */}
</div>
```

Result: The CSS selector `.resume-card-ssr .resume-card-ssr` never matches, so **NONE of the styles apply**, making the entire template invisible/unstyled.

### Why It Happened
The sync script transforms source templates (which use `<html><body>` structure) to React components. The transformation had a **regex ordering bug**:

```typescript
// BROKEN ORDER (lines 189-193 in sync script)
${styles
  .replace(/body \{/g, `.resume-card-ssr {`)        // STEP 1: body { → .resume-card-ssr {
  .replace(/\.([a-z-]+) \{/g, `.resume-card-ssr .$1 {`)  // STEP 2: .resume-card-ssr { → .resume-card-ssr .resume-card-ssr {
  // ...
}
```

**What happened:**
1. Step 1: `body { font-family: ... }` → `.resume-card-ssr { font-family: ... }`
2. Step 2: `.resume-card-ssr {` matches the class regex `\.([a-z-]+) \{` and becomes `.resume-card-ssr .resume-card-ssr {`

## The Fix

### Solution
**Reverse the order** of regex replacements - do class selectors FIRST, then body transformation:

```typescript
// FIXED ORDER (lines 192-206 in sync script)
${styles
  // STEP 1: Transform class selectors first (before body transformation)
  .replace(/\n\s+\.([a-z-]+) \{/g, `\n          .${className} .$1 {`)
  // STEP 2: Transform element selectors
  .replace(/\n\s+header \{/g, `\n          .${className} header {`)
  .replace(/\n\s+h1 \{/g, `\n          .${className} h1 {`)
  // ... (other elements)
  // STEP 3: Transform body LAST (creates .className which won't match the class regex above)
  .replace(/body \{/g, `.${className} {`)
  // ...
}
```

**Now:**
1. Step 1: `.resume-container {` → `.resume-card-ssr .resume-container {` (nested selector - correct!)
2. Step 2: Element selectors like `header {` → `.resume-card-ssr header {` (scoped - correct!)
3. Step 3: `body {` → `.resume-card-ssr {` (single class - correct!)

Result: CSS generates correctly:
```css
/* FIXED - Correct single selector */
.resume-card-ssr {
  font-family: system-ui;
  max-width: 900px;
  /* ... */
}
```

### Files Changed
1. **`scripts/sync-external-templates.ts`** (lines 185-215)
   - Reordered regex replacements
   - Added detailed comments explaining the fix
   - Added CRITICAL comment warning future developers

2. **Generated template files** (auto-fixed by re-running sync):
   - `src/lib/templates/external/card-ssr/Resume.jsx`
   - `src/lib/templates/external/minimal-ssr/Resume.jsx`
   - `src/lib/templates/external/sidebar-ssr/Resume.jsx`
   - `src/lib/templates/external/timeline-ssr/Resume.jsx`

## Verification

### Before Fix
```bash
$ grep -n "\.resume-card-ssr \.resume-card-ssr" src/lib/templates/external/card-ssr/Resume.jsx
31:              .resume-card-ssr .resume-card-ssr {
239:              .resume-card-ssr .resume-card-ssr {
```

### After Fix
```bash
$ grep -n "\.resume-card-ssr \.resume-card-ssr" src/lib/templates/external/card-ssr/Resume.jsx
# No matches (CORRECT!)

$ grep -n "^\s+\.resume-card-ssr \{$" src/lib/templates/external/card-ssr/Resume.jsx
34:              .resume-card-ssr {
242:                .resume-card-ssr {
```

## Why Previous Fixes Didn't Work

1. **`refreshKey` state variable** - Only forces React re-renders, doesn't fix broken CSS
2. **`.maybeSingle()` instead of `.single()`** - Fixed 406 errors, not CSS issues
3. **Cache clearing** - Doesn't fix broken CSS selectors in generated code
4. **Manual template edits** - Were overwritten by sync script on next build

The real issue was in the **build-time template transformation**, not runtime code.

## Prevention Strategy

### 1. Add Test Coverage
Create a test to verify generated templates don't have doubled selectors:

```typescript
// tests/template-sync.test.ts
describe('Template Sync', () => {
  it('should not generate doubled class selectors', () => {
    const templates = ['card-ssr', 'minimal-ssr', 'sidebar-ssr', 'timeline-ssr'];

    templates.forEach(slug => {
      const file = fs.readFileSync(`src/lib/templates/external/${slug}/Resume.jsx`, 'utf-8');
      const regex = new RegExp(`\\.resume-${slug} \\.resume-${slug}`, 'g');
      const matches = file.match(regex);

      expect(matches).toBeNull();  // No doubled selectors allowed
    });
  });
});
```

### 2. Lint Rule
Add ESLint custom rule to detect doubled selectors in template files.

### 3. Documentation
Add inline comments in sync script warning about regex order:

```typescript
// CRITICAL: Order matters! Class selectors must be transformed BEFORE body.
// If body is transformed first, it creates .className which then gets
// doubled by the class selector regex: .className → .className .className
```

### 4. Sync Script Validation
Add post-transform validation to sync script:

```typescript
// After transformation, verify no doubled selectors
const doubledSelectorRegex = new RegExp(`\\.${className} \\.${className}`, 'g');
if (doubledSelectorRegex.test(transformed)) {
  throw new Error(`Sync script bug: Generated doubled selector .${className} .${className}`);
}
```

## Testing Checklist

After fix, verify:
- [ ] Natural design (no template) displays correctly
- [ ] Switch to Card design - page stays stable
- [ ] Switch to Minimal design - page stays stable
- [ ] Switch to Timeline design - page stays stable
- [ ] Switch to Sidebar design - page stays stable
- [ ] Switch back to Natural - page stays stable
- [ ] All resume content visible with proper styling
- [ ] No browser console errors
- [ ] No React warnings about keys or re-renders
- [ ] Build succeeds without errors
- [ ] Templates sync without generating doubled selectors

## Lessons Learned

1. **Build-time bugs are harder to debug** - The bug was in template generation, not runtime code
2. **Sync scripts need tests** - Template transformation is complex and error-prone
3. **Regex order matters** - Sequential replacements can create cascading bugs
4. **Check generated code** - Don't assume build scripts generate correct output
5. **Trace the full pipeline** - From source templates → sync script → generated files → runtime

## Related Issues

- **406 Errors** - Fixed separately by replacing `.single()` with `.maybeSingle()`
- **refreshKey not working** - Was treating symptom, not root cause
- **Manual template edits lost** - Sync script overwrites, need to fix at source

## Date Fixed
2025-10-21

## Author
Claude (Debugging AI Agent)
